<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯è¦‹ä¸å¹³ - é€šå ±èˆ‡è™•ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page-section { display: none; animation: fadeIn 0.4s ease-out; width: 100%; }
        .page-section.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-container {
            padding-top: 100px; 
            padding-bottom: 100px;
            flex: 1;
            width: 100%;
            overflow-x: hidden;
        }

        .auth-tab { cursor: pointer; padding: 12px 0; flex: 1; text-align: center; font-weight: bold; font-size: 1.1rem; color: #9ca3af; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .auth-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .card-shadow { box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15), 0 10px 20px -15px rgba(0, 0, 0, 0.1); }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .custom-footer { background-color: #1e293b; color: #94a3b8; text-align: center; padding: 20px 0; width: 100%; margin-top: auto; }
        .img-preview-box { border: 2px dashed #cbd5e1; border-radius: 12px; height: 200px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; background-color: #f8fafc; transition: all 0.3s; }
        .img-preview-box:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .img-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #mobile-nav { z-index: 999; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4 mx-auto"></div>
            <p class="font-bold text-gray-600 text-lg tracking-wider">ç³»çµ±é€£ç·šä¸­...</p>
        </div>
    </div>

    <!-- é›»è…¦ç‰ˆå°è¦½åˆ— -->
    <header id="desktop-nav" class="hidden md:flex fixed top-0 w-full bg-white/95 backdrop-blur-md shadow-sm z-50 px-8 py-4 justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-400 text-white p-2 rounded-xl shadow-md transform rotate-3 hover:rotate-0 transition duration-300">
                <i class="fas fa-road fa-lg"></i>
            </div>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">è·¯è¦‹ä¸å¹³</h1>
        </div>
        <nav class="flex gap-8 text-gray-500 font-medium">
            <a href="#" onclick="switchTab('home')" class="hover:text-blue-600 transition flex items-center gap-2 cursor-pointer"><i class="fas fa-home opacity-50"></i>é¦–é </a>
            <a href="#" onclick="checkAuthAndSwitch('report')" class="hover:text-blue-600 transition flex items-center gap-2 cursor-pointer"><i class="fas fa-bullhorn opacity-50"></i>é€šå ±</a>
            <a href="#" onclick="checkAuthAndSwitch('status')" class="hover:text-blue-600 transition flex items-center gap-2 cursor-pointer"><i class="fas fa-list-ul opacity-50"></i>æ¡ˆä»¶åˆ—è¡¨æŸ¥è©¢</a>
            <a href="#" onclick="checkAuthAndSwitch('profile')" class="hover:text-blue-600 transition flex items-center gap-2 cursor-pointer"><i class="fas fa-user opacity-50"></i>å€‹äºº</a>
        </nav>
        <button onclick="logout()" class="text-sm border-2 border-red-400 text-red-500 px-5 py-1.5 rounded-full hover:bg-red-500 hover:text-white transition duration-300 font-bold">ç™»å‡º</button>
    </header>

    <main class="main-container">

        <!-- 1. ç™»å…¥/è¨»å†Šé é¢ -->
        <section id="page-auth" class="page-section active">
            <div class="flex flex-col items-center justify-center min-h-[70vh] px-4">
                <div class="bg-white p-8 md:p-14 rounded-[2.5rem] card-shadow w-full max-w-2xl relative overflow-hidden mx-auto transform transition duration-500 mb-10">
                    <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400"></div>
                    <div class="text-center mb-10">
                        <h2 class="text-3xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-blue-400 mb-4 tracking-tight">è·¯è¦‹ä¸å¹³é€šå ±</h2>
                        <p class="text-gray-400 text-sm md:text-lg">å…±åŒç¶­è­·ç¾å¥½çš„åŸå¸‚é“è·¯ï¼Œè«‹å…ˆç™»å…¥ç³»çµ±</p>
                    </div>
                    <div class="flex border-b-2 border-gray-100 mb-8">
                        <div id="tab-login" class="auth-tab active" onclick="toggleAuthMode('login')">å¸³è™Ÿç™»å…¥</div>
                        <div id="tab-register" class="auth-tab" onclick="toggleAuthMode('register')">è¨»å†Šå¸³è™Ÿ</div>
                    </div>
                    
                    <form id="form-login" onsubmit="handleLogin(event)" class="space-y-6 block animate-fade-in">
                        <div class="relative group"><i class="fas fa-user absolute left-5 top-4 text-xl text-gray-300 group-focus-within:text-blue-500 transition"></i><input type="text" id="login-username" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿ" required class="w-full bg-gray-50 border-2 border-transparent rounded-2xl py-4 pl-14 pr-6 text-lg focus:bg-white focus:border-blue-200 outline-none transition duration-300"></div>
                        <div class="relative group"><i class="fas fa-lock absolute left-5 top-4 text-xl text-gray-300 group-focus-within:text-blue-500 transition"></i><input type="password" id="login-password" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¯†ç¢¼" required class="w-full bg-gray-50 border-2 border-transparent rounded-2xl py-4 pl-14 pr-6 text-lg focus:bg-white focus:border-blue-200 outline-none transition duration-300"></div>
                        <div class="flex justify-end mt-2"><a href="#" class="text-sm text-blue-500 hover:text-blue-700 font-medium transition">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a></div>
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold text-lg py-4 rounded-2xl hover:shadow-xl hover:from-blue-600 hover:to-blue-700 transition transform hover:-translate-y-1 mt-4">ç«‹å³ç™»å…¥</button>
                    </form>

                    <form id="form-register" onsubmit="handleRegister(event)" class="space-y-6 hidden animate-fade-in">
                        <div class="relative group"><i class="fas fa-envelope absolute left-5 top-4 text-xl text-gray-300 group-focus-within:text-green-500 transition"></i><input type="text" id="reg-username" placeholder="è¨­å®šå¸³è™Ÿ (Email)" required class="w-full bg-gray-50 border-2 border-transparent rounded-2xl py-4 pl-14 pr-6 text-lg focus:bg-white focus:border-green-200 outline-none transition duration-300"></div>
                        <div class="relative group"><i class="fas fa-smile absolute left-5 top-4 text-xl text-gray-300 group-focus-within:text-green-500 transition"></i><input type="text" id="reg-name" placeholder="æ‚¨çš„ç¨±å‘¼ (æš±ç¨±)" required class="w-full bg-gray-50 border-2 border-transparent rounded-2xl py-4 pl-14 pr-6 text-lg focus:bg-white focus:border-green-200 outline-none transition duration-300"></div>
                        <div class="relative group"><i class="fas fa-key absolute left-5 top-4 text-xl text-gray-300 group-focus-within:text-green-500 transition"></i><input type="password" id="reg-password" placeholder="è¨­å®šå¯†ç¢¼" required class="w-full bg-gray-50 border-2 border-transparent rounded-2xl py-4 pl-14 pr-6 text-lg focus:bg-white focus:border-green-200 outline-none transition duration-300"></div>
                        <button type="submit" class="w-full bg-gradient-to-r from-green-400 to-teal-500 text-white font-bold text-lg py-4 rounded-2xl hover:shadow-xl hover:from-green-500 hover:to-teal-600 transition transform hover:-translate-y-1 mt-4">ç¢ºèªè¨»å†Š</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- 2. é¦–é  Dashboard -->
        <section id="page-home" class="page-section">
            <div class="max-w-4xl mx-auto px-4">
                <div class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-3xl p-8 text-white mb-8 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-white opacity-10 rounded-full -ml-5 -mb-5"></div>
                    <h2 class="text-3xl font-bold mb-2">æ—©å®‰ï¼Œ<span id="display-name">è¨ªå®¢</span> ğŸ‘‹</h2>
                    <p class="opacity-90 text-lg">ä»Šå¤©ç™¼ç¾äº†ä»€éº¼éœ€è¦æ”¹å–„çš„åœ°æ–¹å—ï¼Ÿ</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <button onclick="checkAuthAndSwitch('report')" class="bg-white p-6 rounded-2xl card-shadow hover:shadow-xl transition transform hover:-translate-y-1 group border border-transparent hover:border-blue-100">
                        <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-500 group-hover:text-white transition duration-300"><i class="fas fa-plus text-2xl"></i></div>
                        <span class="font-bold text-lg text-gray-700 group-hover:text-blue-600">é€šå ±äº‹ä»¶</span>
                        <p class="text-xs text-gray-400 mt-2">ç™¼ç¾å‘æ´ã€è·¯ç‡ˆæ•…éšœ</p>
                    </button>
                    <button onclick="checkAuthAndSwitch('status')" class="bg-white p-6 rounded-2xl card-shadow hover:shadow-xl transition transform hover:-translate-y-1 group border border-transparent hover:border-purple-100">
                        <div class="w-16 h-16 bg-purple-50 text-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:bg-purple-500 group-hover:text-white transition duration-300"><i class="fas fa-search text-2xl"></i></div>
                        <span class="font-bold text-lg text-gray-700 group-hover:text-purple-600">æŸ¥çœ‹é€²åº¦</span>
                        <p class="text-xs text-gray-400 mt-2">è¿½è¹¤æ¡ˆä»¶è™•ç†ç‹€æ…‹</p>
                    </button>
                </div>
            </div>
        </section>

        <!-- 3. äº‹ä»¶é€šå ± -->
        <section id="page-report" class="page-section">
            <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 mx-4">
                <div class="p-6 bg-gradient-to-r from-blue-50 to-white border-b border-gray-100">
                    <h2 class="text-xl font-bold text-blue-800 flex items-center justify-center"><span class="bg-blue-100 p-2 rounded-lg mr-2"><i class="fas fa-edit text-blue-600"></i></span>å¡«å¯«é€šå ±è³‡æ–™</h2>
                </div>
                <div class="p-8 space-y-6">
                    <div><label class="block text-sm font-bold text-gray-700 mb-2 ml-1">ğŸ“ ç™¼ç”Ÿåœ°é»</label><input type="text" id="report-location" placeholder="è«‹è¼¸å…¥åœ°å€æˆ–æè¿°ä½ç½®" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-bold text-gray-700 mb-2 ml-1">ğŸ“… æ—¥æœŸ</label><input type="date" id="report-date" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-2 ml-1">ğŸ•’ æ™‚é–“</label><input type="time" id="report-time" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition"></div>
                    </div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-2 ml-1">ğŸ“ è©³ç´°æè¿°</label><textarea id="report-desc" rows="4" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="è«‹è©³ç´°æè¿°å•é¡Œç‹€æ³..."></textarea></div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">ğŸ“· ç¾å ´ç…§ç‰‡</label>
                        <div class="img-preview-box" onclick="document.getElementById('report-file').click()">
                            <div id="upload-placeholder" class="text-center text-gray-400"><i class="fas fa-cloud-upload-alt text-4xl mb-2"></i><p>é»æ“Šé¸æ“‡ç…§ç‰‡ (ç›¸ç°¿/æ‹ç…§)</p></div>
                            <img id="img-preview" src="" alt="é è¦½" class="hidden h-full">
                        </div>
                        <input type="file" id="report-file" class="hidden" accept="image/*" onchange="previewImage(this)">
                        <input type="hidden" id="report-img-base64">
                    </div>
                </div>
                <div class="p-6 bg-gray-50 flex gap-4">
                    <button onclick="switchTab('home')" class="flex-1 bg-white border border-gray-300 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-50 transition">å–æ¶ˆ</button>
                    <button onclick="submitReport()" class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:from-blue-600 hover:to-indigo-700 transition transform hover:-translate-y-0.5"><i class="fas fa-paper-plane mr-2"></i>é€å‡ºé€šå ±</button>
                </div>
            </div>
        </section>

        <!-- æ–°å¢ï¼šé€šå ±æˆåŠŸé é¢ -->
        <section id="page-success" class="page-section">
            <div class="flex flex-col items-center justify-center min-h-[60vh] px-4">
                <div class="bg-white p-8 rounded-[2rem] card-shadow w-full max-w-lg text-center">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check text-4xl text-green-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">é€šå ±æˆåŠŸï¼</h2>
                    <p class="text-gray-500 mb-6">æ‚¨çš„æ¡ˆä»¶å·²æˆåŠŸé€å‡ºï¼Œç›¸é—œå–®ä½å°‡ç›¡å¿«è™•ç†ã€‚</p>
                    
                    <div class="bg-gray-50 p-4 rounded-xl mb-8">
                        <p class="text-sm text-gray-400 mb-1">æ¡ˆä»¶ç·¨è™Ÿ</p>
                        <p class="text-2xl font-bold text-blue-600 tracking-wider" id="success-case-id">R-000000</p>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="switchTab('home')" class="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200 transition">è¿”å›é¦–é </button>
                        <button onclick="loadMyReports()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">æŸ¥çœ‹æˆ‘çš„ç´€éŒ„</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. æ¡ˆä»¶åˆ—è¡¨æŸ¥è©¢ -->
        <section id="page-status" class="page-section">
            <div class="max-w-2xl mx-auto px-4">
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <h2 class="font-bold text-xl text-gray-800 mb-4 text-center">æ¡ˆä»¶åˆ—è¡¨æŸ¥è©¢</h2>
                    <div class="flex gap-2 mb-6">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="è¼¸å…¥æ¡ˆä»¶ç·¨è™Ÿæˆ–åœ°å€..." class="w-full bg-gray-50 border border-gray-200 rounded-xl pl-10 pr-4 py-2 focus:bg-white focus:ring-2 focus:ring-blue-200 outline-none">
                        </div>
                        <button onclick="loadReports()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-700 transition">æŸ¥è©¢</button>
                    </div>
                    <div id="status-list" class="space-y-4">
                        <div class="text-center py-12"><div class="text-gray-300 text-6xl mb-4"><i class="fas fa-inbox"></i></div><p class="text-gray-400">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œæˆ–è«‹è¼¸å…¥é—œéµå­—æŸ¥è©¢</p></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ–°å¢ï¼šæˆ‘çš„é€šå ±ç´€éŒ„ -->
        <section id="page-my-reports" class="page-section">
            <div class="max-w-2xl mx-auto px-4">
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <div class="flex items-center mb-6">
                        <button onclick="switchTab('profile')" class="mr-4 text-gray-400 hover:text-blue-600"><i class="fas fa-arrow-left text-xl"></i></button>
                        <h2 class="font-bold text-xl text-gray-800">æˆ‘çš„é€šå ±ç´€éŒ„</h2>
                    </div>
                    <div id="my-reports-list" class="space-y-4">
                        <!-- JS å¡«å…… -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. å€‹äººä¸­å¿ƒ -->
        <section id="page-profile" class="page-section">
            <div class="max-w-md mx-auto bg-white rounded-3xl shadow-xl mt-8 p-8 relative overflow-hidden mx-4">
                <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-blue-400 to-purple-500"></div>
                <div class="relative text-center mt-4">
                    <div class="w-24 h-24 bg-white p-1 rounded-full mx-auto shadow-lg"><div class="w-full h-full bg-gray-100 rounded-full flex items-center justify-center text-4xl text-gray-400 overflow-hidden"><img id="profile-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=guest" alt="avatar" class="w-full h-full"></div></div>
                    <h3 class="font-bold text-2xl mt-4 mb-1 text-gray-800" id="profile-name">æœªç™»å…¥</h3>
                    <span class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full font-bold" id="profile-status">è¨ªå®¢</span>
                </div>
                <div class="mt-8 space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl flex items-center">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-500 shadow-sm mr-4"><i class="fas fa-envelope"></i></div>
                        <div><p class="text-xs text-gray-400">ç™»å…¥å¸³è™Ÿ</p><p class="font-medium text-gray-700" id="profile-account">--</p></div>
                    </div>
                    
                    <!-- æ–°å¢ï¼šæŸ¥çœ‹ç´€éŒ„æŒ‰éˆ• -->
                    <button onclick="loadMyReports()" class="w-full bg-blue-50 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-100 transition flex items-center justify-center gap-2">
                        <i class="fas fa-clipboard-list"></i> æŸ¥çœ‹æˆ‘çš„é€šå ±ç´€éŒ„
                    </button>
                </div>
                <div class="mt-4">
                    <button onclick="logout()" class="w-full border-2 border-red-100 text-red-400 py-3 rounded-xl font-bold hover:bg-red-50 hover:text-red-500 transition">ç™»å‡ºå¸³è™Ÿ</button>
                </div>
            </div>
        </section>

    </main>

    <footer class="custom-footer">
        <p>&copy; ã€Œè·¯è¦‹ä¸å¹³ã€é€šå ±è™•ç†ç³»çµ±</p>
    </footer>

    <nav id="mobile-nav" class="md:hidden fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 flex justify-around py-2 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('home')" class="nav-btn flex flex-col items-center w-16 text-gray-400 hover:text-blue-600 transition pt-2"><i class="fas fa-home mb-1 text-lg"></i><span class="font-bold text-[10px]">é¦–é </span></button>
        <button onclick="checkAuthAndSwitch('status')" class="nav-btn flex flex-col items-center w-16 text-gray-400 hover:text-blue-600 transition pt-2"><i class="fas fa-clipboard-list mb-1 text-lg"></i><span class="font-bold text-[10px]">æŸ¥è©¢</span></button>
        <button onclick="checkAuthAndSwitch('report')" class="nav-btn flex flex-col items-center w-20 -mt-6">
            <div class="bg-gradient-to-tr from-blue-500 to-indigo-500 text-white rounded-2xl w-14 h-14 flex items-center justify-center shadow-lg transform rotate-45 hover:rotate-0 transition duration-300 border-4 border-gray-50"><i class="fas fa-plus text-xl transform -rotate-45"></i></div>
            <span class="text-blue-600 font-bold mt-1 text-[10px]">æ–°å¢é€šå ±</span>
        </button>
        <button onclick="checkAuthAndSwitch('profile')" class="nav-btn flex flex-col items-center w-16 text-gray-400 hover:text-blue-600 transition pt-2"><i class="fas fa-user mb-1 text-lg"></i><span class="font-bold text-[10px]">å€‹äºº</span></button>
    </nav>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxBywZe2oRIHUfuVqIkKKiZVxKTMg-xf370YcFvLAwQcZ6y21VLXlUQKaOfJvoOfbA9Rg/exec'; 
        let currentUser = null;

        function checkAuthAndSwitch(pageId) {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼');
                switchTab('auth');
                toggleAuthMode('login');
                return;
            }
            switchTab(pageId);
        }

        function toggleAuthMode(mode) {
            const loginForm = document.getElementById('form-login');
            const regForm = document.getElementById('form-register');
            const loginTab = document.getElementById('tab-login');
            const regTab = document.getElementById('tab-register');
            if (mode === 'login') {
                loginForm.classList.remove('hidden'); regForm.classList.add('hidden'); loginTab.classList.add('active'); regTab.classList.remove('active');
            } else {
                loginForm.classList.add('hidden'); regForm.classList.remove('hidden'); loginTab.classList.remove('active'); regTab.classList.add('active');
            }
        }

        function switchTab(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            const targetId = (pageId === 'login' || pageId === 'register') ? 'auth' : pageId;
            document.getElementById('page-' + targetId).classList.add('active');

            const isAuthPage = (targetId === 'auth');
            const desktopNav = document.getElementById('desktop-nav');
            const mobileNav = document.getElementById('mobile-nav');

            if (isAuthPage) {
                if(desktopNav) desktopNav.classList.add('hidden');
                if(mobileNav) mobileNav.style.display = 'none';
                document.querySelector('.custom-footer').style.display = 'block'; 
            } else {
                if(desktopNav) desktopNav.classList.remove('hidden');
                if(mobileNav) mobileNav.style.display = 'flex';
                document.querySelector('.custom-footer').style.display = 'block';
            }
            
            if(pageId === 'report') resetReportForm();
            if(pageId === 'status') loadReports(); // Use default param here
            
            if(pageId === 'profile' && currentUser) {
                document.getElementById('profile-name').innerText = currentUser.name;
                document.getElementById('profile-account').innerText = currentUser.username;
                document.getElementById('profile-status').className = 'bg-green-100 text-green-600 text-xs px-3 py-1 rounded-full font-bold';
                document.getElementById('profile-status').innerText = 'å·²èªè­‰æœƒå“¡';
                document.getElementById('profile-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.username}`;
            }

            window.scrollTo(0,0);
        }

        function resetReportForm() {
            document.getElementById('report-location').value = '';
            document.getElementById('report-date').valueAsDate = new Date();
            document.getElementById('report-time').value = new Date().toTimeString().slice(0,5);
            document.getElementById('report-desc').value = '';
            document.getElementById('report-file').value = '';
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('img-preview').classList.add('hidden');
            document.getElementById('img-preview').src = '';
            document.getElementById('report-img-base64').value = '';
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('img-preview').classList.remove('hidden');
                    document.getElementById('upload-placeholder').classList.add('hidden');
                    document.getElementById('report-img-base64').value = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }

        function handleRegister(e) {
            e.preventDefault();
            toggleLoading(true);
            const data = { action: 'register', username: document.getElementById('reg-username').value, name: document.getElementById('reg-name').value, password: document.getElementById('reg-password').value };
            
            // Corrected: Use URLSearchParams for POST body to match GAS requirement
            fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                // Removed headers: { 'Content-Type': 'application/json' },
                body: new URLSearchParams(data) 
            })
            .then(() => { toggleLoading(false); alert('è¨»å†Šè«‹æ±‚å·²é€å‡ºï¼è«‹å˜—è©¦ç™»å…¥ã€‚'); toggleAuthMode('login'); })
            .catch(err => { toggleLoading(false); alert('é€£ç·šéŒ¯èª¤ï¼š' + err); });
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            currentUser = { username: username, name: username.split('@')[0] }; 
            document.getElementById('display-name').innerText = currentUser.name;
            alert('ç™»å…¥æˆåŠŸï¼'); switchTab('home');
        }

        function logout() { 
            currentUser = null; 
            document.getElementById('profile-name').innerText = 'æœªç™»å…¥';
            document.getElementById('profile-account').innerText = '--';
            document.getElementById('profile-status').innerText = 'è¨ªå®¢';
            document.getElementById('profile-avatar').src = 'https://api.dicebear.com/7.x/avataaars/svg?seed=guest';
            toggleAuthMode('login'); 
            switchTab('auth'); 
        }

        function submitReport() {
            if(!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
            
            // ç”¢ç”Ÿä¸€å€‹å‰ç«¯çš„æ¡ˆä»¶ç·¨è™Ÿ
            const caseId = 'R-' + Date.now().toString().slice(-6);
            
            const reportData = {
                action: 'report',
                id: caseId, // å‚³é€ ID çµ¦å¾Œç«¯ (è‹¥å¾Œç«¯æœ‰æ”¯æ´)
                reporter: currentUser.username,
                location: document.getElementById('report-location').value,
                date: document.getElementById('report-date').value,
                time: document.getElementById('report-time').value,
                desc: document.getElementById('report-desc').value,
                imageBase64: document.getElementById('report-img-base64').value, // Add image data
                note: "åœ–ç‰‡å·²ä¸Šå‚³" 
            };
            toggleLoading(true);
            
            // Corrected: Use URLSearchParams for POST body to match GAS requirement
            fetch(GOOGLE_SCRIPT_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                // Removed headers: { 'Content-Type': 'application/json' },
                body: new URLSearchParams(reportData) 
            })
            .then(() => { 
                toggleLoading(false); 
                // åˆ‡æ›åˆ°æˆåŠŸé é¢
                document.getElementById('success-case-id').innerText = caseId;
                switchTab('success');
                resetReportForm();
            })
            .catch(err => { toggleLoading(false); alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + err); });
        }

        function loadReports() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            toggleLoading(true);
            
            // Added timestamp to prevent caching
            fetch(GOOGLE_SCRIPT_URL + '?action=getReports&_t=' + new Date().getTime())
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                const list = document.getElementById('status-list');
                list.innerHTML = '';
                
                if (!Array.isArray(data)) { console.error(data); return; }

                const filteredData = data.filter(item => 
                    (item.id && item.id.toString().toLowerCase().includes(searchTerm)) || 
                    (item.location && item.location.toLowerCase().includes(searchTerm))
                );
                if(!filteredData || filteredData.length === 0) { list.innerHTML = '<div class="text-center py-10 text-gray-400">æŸ¥ç„¡è³‡æ–™</div>'; return; }
                filteredData.forEach(item => {
                    const statusClass = item.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600';
                    const icon = item.status === 'å·²å®Œæˆ' ? 'fa-check-circle' : 'fa-clock';
                    const html = `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-50 text-blue-500 font-bold px-2 py-1 rounded text-xs">#${item.id}</span>
                                <span class="${statusClass} text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1"><i class="fas ${icon}"></i> ${item.status || 'è™•ç†ä¸­'}</span>
                            </div>
                            <span class="text-xs text-gray-400">${item.date}</span>
                        </div>
                        <h3 class="font-bold text-gray-800 mb-1 text-lg">${item.location}</h3>
                        <p class="text-sm text-gray-500 line-clamp-2">${item.desc}</p>
                    </div>`;
                    list.innerHTML += html;
                });
            }).catch(err => { toggleLoading(false); console.error(err); });
        }

        // æ–°å¢ï¼šè¼‰å…¥æˆ‘çš„ç´€éŒ„
        function loadMyReports() {
            switchTab('my-reports');
            if(!GOOGLE_SCRIPT_URL.startsWith('http')) return;
            toggleLoading(true);
            
             // Added timestamp to prevent caching
            fetch(GOOGLE_SCRIPT_URL + '?action=getReports&_t=' + new Date().getTime())
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                const list = document.getElementById('my-reports-list');
                list.innerHTML = '';
                
                if (!Array.isArray(data)) { console.error(data); return; }
                
                // ç¯©é¸æœ¬äººæ¡ˆä»¶ (Improved matching logic)
                const myData = data.filter(item => {
                     const reporter = (item.reporter || '').toLowerCase().trim();
                     const user = (currentUser.username || '').toLowerCase().trim();
                     return reporter === user;
                });
                
                if(!myData || myData.length === 0) { list.innerHTML = '<div class="text-center py-10 text-gray-400">æ‚¨å°šæœªé€šå ±ä»»ä½•æ¡ˆä»¶</div>'; return; }
                myData.forEach(item => {
                     const statusClass = item.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600';
                     const html = `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-3">
                            <span class="bg-blue-50 text-blue-500 font-bold px-2 py-1 rounded text-xs">#${item.id}</span>
                            <span class="${statusClass} text-xs px-2 py-1 rounded-full font-bold">${item.status || 'è™•ç†ä¸­'}</span>
                        </div>
                        <h3 class="font-bold text-gray-800 mb-1 text-lg">${item.location}</h3>
                        <p class="text-sm text-gray-500">${item.desc}</p>
                    </div>`;
                    list.innerHTML += html;
                });
            }).catch(err => { toggleLoading(false); console.error(err); });
        }

        switchTab('auth');
    </script>
</body>
</html>